version: '2.1'
services:

    #
    # mender-deployments
    #
    mender-deployments:
        image: mendersoftware/deployments:master
        extends:
            file: common.yml
            service: mender-base
        networks:
            - mender
        depends_on:
            - mender-mongo
            - storage-proxy

    #
    # mender-gui
    #
    mender-gui:
        image: mendersoftware/gui:master
        extends:
            file: common.yml
            service: mender-base
        networks:
            - mender
        environment:
            - GATEWAY_IP
            - INTEGRATION_VERSION
            - MENDER_ARTIFACT_VERSION
            - MENDER_VERSION
            - MENDER_DEB_PACKAGE_VERSION

    #
    # mender-api-gateway
    #
    mender-api-gateway:
        image: mendersoftware/api-gateway:master
        extends:
            file: common.yml
            service: mender-base
        networks:
            - mender
        # critical - otherwise nginx may not detect
        # these servers and exits with 'upstream server not found'
        depends_on:
            mender-gui: service_healthy

        depends_on:
            mender-deployments:
                condition: service_healthy

        depends_on:
            mender-useradm:
                condition: service_healthy

        depends_on:
            mender-inventory:
                condition: service_healthy

        depends_on:
            mender-device-auth:
                condition: service_healthy

    #
    # mender-device-auth
    #
    mender-device-auth:
        image: mendersoftware/deviceauth:master
        extends:
            file: common.yml
            service: mender-base
        networks:
            - mender
        depends_on:
            - mender-mongo
            - mender-conductor

    #
    # mender-inventory
    #
    mender-inventory:
        image: mendersoftware/inventory:master
        extends:
            file: common.yml
            service: mender-base
        networks:
            - mender
        depends_on:
            - mender-mongo

    #
    # mender-useradm
    #
    mender-useradm:
        image: mendersoftware/useradm:master
        extends:
            file: common.yml
            service: mender-base
        networks:
            - mender
        depends_on:
            - mender-mongo

    mender-mongo:
        image: mongo:3.6
        extends:
            file: common.yml
            service: mender-base
        networks:
            mender:
                aliases:
                    - mongo-tenantadm
                    - mongo-deployments
                    - mongo-device-auth
                    - mongo-inventory
                    - mongo-useradm
        tmpfs:
            - /data

    mender-conductor:
        environment:
            - CONDUCTOR_JAVA_OPTS=-Xms1024m -Xmx2048m
        image: mendersoftware/mender-conductor:2.11.0-es6
        depends_on:
            - mender-elasticsearch
            - mender-redis
        extends:
            file: common.yml
            service: mender-base
        networks:
            - mender

    mender-elasticsearch:
        environment:
            - ES_NETWORK_HOST=0.0.0.0
            - ES_JAVA_OPTS=-Xms1024m -Xmx2048m
        image: docker.elastic.co/elasticsearch/elasticsearch:6.8.5
#         image: elasticsearch:5-alpine
        extends:
            file: common.yml
            service: mender-base
        networks:
            - mender
        tmpfs:
            - /usr/share/elasticsearch/data

    mender-redis:
        image: redis:5-alpine3.8
        extends:
            file: common.yml
            service: mender-base
        networks:
            - mender
        tmpfs:
            - /data



networks:
    mender:
