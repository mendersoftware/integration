FROM openresty/openresty:1.13.6.2-2-bionic

ENV DEBIAN_FRONTEND noninteractive
COPY sources.list /etc/apt/sources.list
RUN apt-get update && apt-get -y source nginx-full && apt-get -y build-dep nginx-full && apt-get install -y bash vim wget build-essential zlib1g-dev elfutils libdw-dev gettext git linux-headers-5.0.0-1025-gcp linux-source-5.0.0 && apt-get source libpcre3 && apt-get source openssl && mv pcre3-8.39 /tmp && mv openssl-1.1.0g /tmp

RUN wget https://openresty.org/download/openresty-1.13.6.2.tar.gz; wget https://github.com/simplresty/ngx_devel_kit/archive/v0.3.0.tar.gz;wget https://github.com/openresty/echo-nginx-module/archive/v0.61.tar.gz;wget https://github.com/openresty/echo-nginx-module/archive/v0.61.tar.gz;wget https://github.com/openresty/xss-nginx-module/archive/v0.06.tar.gz;wget https://github.com/FRiCKLE/ngx_coolkit/archive/0.2.tar.gz;wget https://github.com/openresty/set-misc-nginx-module/archive/v0.32.tar.gz;wget https://github.com/calio/form-input-nginx-module/archive/v0.12.tar.gz;wget https://github.com/openresty/encrypted-session-nginx-module/archive/v0.08.tar.gz;wget https://github.com/openresty/srcache-nginx-module/archive/v0.31.tar.gz;wget https://github.com/openresty/lua-nginx-module/archive/v0.10.13.tar.gz;wget https://github.com/openresty/lua-upstream-nginx-module/archive/v0.07.tar.gz;wget https://github.com/openresty/headers-more-nginx-module/archive/v0.33.tar.gz;wget https://github.com/openresty/array-var-nginx-module/archive/v0.05.tar.gz;wget https://github.com/openresty/memc-nginx-module/archive/v0.19.tar.gz;wget https://github.com/openresty/redis2-nginx-module/archive/v0.15.tar.gz;wget https://github.com/onnimonni/redis-nginx-module/archive/v0.3.7.tar.gz;wget https://github.com/openresty/rds-json-nginx-module/archive/v0.15.tar.gz;wget https://github.com/openresty/rds-csv-nginx-module/archive/v0.09.tar.gz;wget https://github.com/openresty/stream-lua-nginx-module/archive/v0.0.5.tar.gz;wget https://github.com/openresty/lua-nginx-module/archive/v0.10.13.tar.gz;wget https://github.com/openresty/headers-more-nginx-module/archive/v0.33.tar.gz;wget https://github.com/openresty/redis2-nginx-module/archive/v0.15.tar.gz; for i in *.tar.gz; do tar zxvf $i; done; cd openresty-1.13.6.2 && ./configure --prefix=/usr/local/openresty --with-debug --with-cc-opt=-O2 --with-ld-opt=-Wl,-rpath,/usr/local/openresty/luajit/lib --with-openssl=/tmp/openssl-1.1.0g --with-pcre=/tmp/pcre3-8.39 --with-file-aio --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_geoip_module=dynamic --with-http_gunzip_module --with-http_gzip_static_module --with-http_image_filter_module=dynamic --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-http_xslt_module=dynamic --with-ipv6 --with-mail --with-mail_ssl_module --with-md5-asm --with-pcre-jit --with-sha1-asm --with-stream --with-stream_ssl_module --with-threads --with-stream --with-stream_ssl_module && make && make install
