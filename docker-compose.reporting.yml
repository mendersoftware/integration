version: '2.1'
services:
    #
    # mender-reporting
    #
    mender-reporting:
        image: mendersoftware/reporting:staging
        command: server --automigrate
        extends:
            file: common.yml
            service: mender-base
        networks:
            - mender
        depends_on:
            - mender-opensearch
        environment:
            REPORTING_OPENSEARCH_ADDRESSES: "http://mender-opensearch:9200"

    #
    # mender-reporting-indexer
    #
    mender-reporting-indexer:
        image: mendersoftware/reporting:mender-master
        command: indexer
        extends:
            file: common.yml
            service: mender-base
        networks:
            - mender
        depends_on:
            - mender-opensearch
        environment:
            REPORTING_OPENSEARCH_ADDRESSES: "http://mender-opensearch:9200"

    #
    # mender-api-gateway
    #
    mender-api-gateway:
      volumes:
        - ./config/traefik/traefik.reporting.yaml:/etc/traefik/config/traefik.reporting.yaml:ro

    #
    # opensearch
    #
    mender-opensearch:
        image: opensearchproject/opensearch:2.4.0
        environment:
          - "discovery.type=single-node"
          - "plugins.security.disabled=true"
          - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
        ports:
            - 9200:9200
        networks:
            - mender

    #
    # mender-inventory
    #
    mender-inventory:
        environment:
            INVENTORY_ORCHESTRATOR_ADDR: http://mender-workflows-server:8080/
            INVENTORY_ENABLE_REPORTING: 1

    #
    # mender-deployments
    #
    mender-deployments:
        environment:
            DEPLOYMENTS_REPORTING_ADDR: http://mender-reporting:8080

    #
    # gui
    #
    mender-gui:
        environment:
            HAVE_REPORTING: 1
